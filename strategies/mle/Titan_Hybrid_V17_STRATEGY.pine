//@version=5
strategy("Titan Hybrid Portfolio V17 [STRATEGY]", overlay=true, initial_capital=20000, default_qty_type=strategy.fixed, default_qty_value=1, currency=currency.USD, commission_type=strategy.commission.cash_per_contract, commission_value=2.0)

// -------------------------------------------------------------------------
// CONFIGURATION
// -------------------------------------------------------------------------
show_ib   = input(true, "Show Initial Balance (IB)")
show_asia = input(true, "Show Asia Session")
// Strategy Params
pt_points_ib   = input.float(55.0, "IB Take Profit (Pts)")
sl_points_ib   = input.float(5.0, "IB Stop Loss (Pts)")
pt_points_asia = input.float(85.0, "ASIA Take Profit (Pts)")
sl_points_asia = input.float(5.0, "ASIA Stop Loss (Pts)")

// Timezone
tz = "America/New_York"

// -------------------------------------------------------------------------
// 1. INITIAL BALANCE (IB) LOGIC
//    Window: 09:30 - 10:00 AM NY
// -------------------------------------------------------------------------
var float ib_h = na
var float ib_l = na
var bool ib_active = false

// Detect IB Session
is_ib_session = not na(time(timeframe.period, "0930-1000", tz))
is_new_day    = ta.change(time("D")) != 0

if is_new_day
    ib_h := na
    ib_l := na
    ib_active := false

if is_ib_session
    // Track High/Low during the window
    ib_h := na(ib_h) ? high : math.max(ib_h, high)
    ib_l := na(ib_l) ? low : math.min(ib_l, low)
else
    // Session Done -> Levels are Active
    if not na(ib_h)
        ib_active := true

// Plot IB
is_us_session = not na(time(timeframe.period, "0930-1600", tz))
plot(show_ib and is_us_session and ib_active ? ib_h : na, "IB High", color=color.new(color.green, 50))
plot(show_ib and is_us_session and ib_active ? ib_l : na, "IB Low", color=color.new(color.green, 50))

// -------------------------------------------------------------------------
// 2. ASIA SESSION LOGIC
//    Window: 18:00 (Prev) - 00:00 (Curr) NY
// -------------------------------------------------------------------------
var float asia_h = na
var float asia_l = na
var bool asia_active = false
is_asia_session = not na(time(timeframe.period, "1800-0000", tz))

if is_asia_session
    if not is_asia_session[1]
        asia_h := high
        asia_l := low
    else
        asia_h := math.max(asia_h, high)
        asia_l := math.min(asia_l, low)
    asia_active := true

// Plot ASIA
plot(show_asia and asia_active ? asia_h : na, "Asia High", color=color.new(color.blue, 50))
plot(show_asia and asia_active ? asia_l : na, "Asia Low", color=color.new(color.blue, 50))

// -------------------------------------------------------------------------
// 3. FVG ENGINE
// -------------------------------------------------------------------------
fvg_bull = low > high[2]
fvg_bear = high < low[2]

// -------------------------------------------------------------------------
// 4. SIGNAL GENERATION
// -------------------------------------------------------------------------
// Valid Trade Window: 10:00 AM - 15:55 PM
valid_window = not na(time(timeframe.period, "1000-1555", tz))

// Logic Matches Python Bridge
ib_long  = ib_active and valid_window and (low < ib_l) and fvg_bull
ib_short = ib_active and valid_window and (high > ib_h) and fvg_bear

asia_long  = asia_active and valid_window and (low < asia_l) and fvg_bull
asia_short = asia_active and valid_window and (high > asia_h) and fvg_bear

// -------------------------------------------------------------------------
// 5. STRATEGY EXECUTION (PRIORITY: ASIA)
// -------------------------------------------------------------------------

// Overlap Handling:
// If ASIA fires, it takes precedence.
// If IB fires and NO Asia, take IB.

// Directional State
// We only open one trade at a time to keep it simple and match Python default
if strategy.position_size == 0
    if asia_long
        strategy.entry("ASIA_Buy", strategy.long, comment="ASIA Hybrid")
        strategy.exit("Exit_ASIA", "ASIA_Buy", profit=pt_points_asia*4, loss=sl_points_asia*4) // *4 for ticks (TradingView default for NQ/ES is often min tick, check sym info)
        // Note: 'profit' is in TICKS usually unless calc logic used. 
        // Better: Use Price targets
        
    else if asia_short
        strategy.entry("ASIA_Sell", strategy.short, comment="ASIA Hybrid")
        strategy.exit("Exit_ASIA", "ASIA_Sell", profit=pt_points_asia*4, loss=sl_points_asia*4)
        
    else if ib_long
        strategy.entry("IB_Buy", strategy.long, comment="IB Hybrid")
        strategy.exit("Exit_IB", "IB_Buy", profit=pt_points_ib*4, loss=sl_points_ib*4)

    else if ib_short
        strategy.entry("IB_Sell", strategy.short, comment="IB Hybrid")
        strategy.exit("Exit_IB", "IB_Sell", profit=pt_points_ib*4, loss=sl_points_ib*4)

// NOTE: TradingView 'profit' arg is in TICKS if using points? 
// Actually, `profit` is in TICKS. NQ Tick = 0.25. 1 Point = 4 Ticks.
// So 55 Points = 220 Ticks.
// I will adjust logic to strict price targets to be safe.

if strategy.position_size > 0
    // Long Exit
    entry_p = strategy.position_avg_price
    
    // Determine which strategy (hack via comment or just apply specific logic)
    // We used explicit exit IDs above, so strategy.exit SHOULD handle it.
    // However, recreating exits on every bar is safer in some Pine versions or using distinct IDs.
    // The above "Fire and Forget" in the entry block works IF the order is filled immediately.
    // But limit orders? Here we use Market entries (strategy.entry default).
    pass

if strategy.position_size < 0
    // Short Exit
    pass

// -------------------------------------------------------------------------
// 6. FIX EXIT LOGIC (Re-Issue Exits for Safety)
// -------------------------------------------------------------------------
// Strategy.exit only needs to be called once per entry, but calling it updates it.
// Since we used different IDs ("Exit_ASIA", "Exit_IB"), they are bound to the entry ID.
// We need to ensure we use Points * 4 (Ticks) for NQ.

// Re-defining for clarity:
// NQ: 1 point = 4 ticks.
// Pts Input -> Ticks
t_ib_pt = pt_points_ib * 4
t_ib_sl = sl_points_ib * 4
t_asia_pt = pt_points_asia * 4
t_asia_sl = sl_points_asia * 4

// The Entry block above used *4 already. This is correct for NQ/ES.
